# エラーハンドリング

## 概要

Kerutaアプリケーションでは、ユーザーフレンドリーで詳細なエラーレスポンスを提供するために、グローバルな例外ハンドリングメカニズムを実装しています。これにより、クライアントは発生した問題を容易に理解し、適切な対応を取ることができます。

## エラーレスポンスの形式

すべてのエラーレスポンスは以下の標準形式で返されます：

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "詳細なエラーメッセージ",
    "status": 400
  },
  "meta": {
    "timestamp": "2023-06-18T14:03:31.262Z",
    "version": "1.0.0"
  }
}
```

### フィールドの説明

- `error`: エラーに関する情報を含むオブジェクト
  - `code`: エラーの種類を示す一意のコード
  - `message`: ユーザーフレンドリーなエラーメッセージ
  - `status`: HTTPステータスコード
- `meta`: メタデータを含むオブジェクト
  - `timestamp`: エラーが発生した時刻（ISO 8601形式）
  - `version`: APIのバージョン

## 主なエラーコード

| コード | HTTPステータス | 説明 |
|--------|--------------|------|
| `UNAUTHORIZED` | 401 | 認証が必要、または認証情報が無効 |
| `RESOURCE_NOT_FOUND` | 404 | 要求されたリソースが見つからない |
| `INVALID_INPUT` | 400 | 無効な入力パラメータ |
| `INTERNAL_SERVER_ERROR` | 500 | サーバー内部エラー |

## 例外ハンドリング

アプリケーションでは、以下の例外に対して特別なハンドリングを行っています：

### 認証エラー

認証に関連するエラーは、より詳細な情報を提供するために特別に処理されます：

- セッション期限切れ
- 無効な認証情報
- アカウントの無効化
- アカウントのロック

### リソース未検出エラー

`NoSuchElementException`が発生した場合、404 Not Foundレスポンスが返され、どのリソースが見つからなかったかを示す詳細なメッセージが含まれます。

### 無効な入力エラー

`IllegalArgumentException`が発生した場合、400 Bad Requestレスポンスが返され、入力の何が無効だったかを示す詳細なメッセージが含まれます。

### その他のエラー

その他の未処理の例外が発生した場合、500 Internal Server Errorレスポンスが返され、問題が通知されたことをユーザーに伝えるメッセージが含まれます。

## エラーハンドリングの実装

エラーハンドリングは以下のコンポーネントによって実装されています：

1. `GlobalExceptionHandler` - Spring の `@ControllerAdvice` を使用して、アプリケーション全体の例外をキャッチし、適切なエラーレスポンスを生成します。

2. `RestAuthenticationEntryPoint` - Spring Security の認証エラーをキャッチし、詳細なエラーメッセージを含むJSONレスポンスを返します。

これらのコンポーネントにより、アプリケーション全体で一貫したエラーハンドリングが保証されます。
