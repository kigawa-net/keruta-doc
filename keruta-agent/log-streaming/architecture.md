# ログストリーミング アーキテクチャ概要

> **概要**: keruta-agentからkeruta本体、データベース、クライアントへスクリプトの実行ログをリアルタイムでストリーミングする機能のアーキテクチャ設計です。

## システム概要

keruta-agentは、Kubernetes Job内で実行されるスクリプトの標準出力・標準エラー出力をリアルタイムでキャプチャし、以下の3つの宛先にストリーミングします：

1. **keruta本体**: WebSocket経由でリアルタイム送信
2. **データベース**: 構造化ログとして永続化
3. **クライアント**: 管理パネルでのリアルタイム表示

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────┐
│                Kubernetes Pod                           │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              keruta-agent                          │ │
│  │                                                     │
│  │  ┌─────────────────┐    ┌─────────────────────────┐ │ │
│  │  │   User Script   │    │   Log Streaming        │ │ │
│  │  │   (Subprocess)  │◄───│   Engine               │ │ │
│  │  │                 │    │                         │ │ │
│  │  │ #!/bin/bash     │    │  • リアルタイムキャプチャ│ │ │
│  │  │ echo "hello"    │    │  • WebSocket送信       │ │ │
│  │  │ exit 0          │    │  • DB保存              │ │ │
│  │  └─────────────────┘    └─────────────────────────┘ │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌──────────────────────────────┐
                    │     keruta API (WebSocket)   │
                    │   (Spring Boot)              │
                    │                              │
                    │  • リアルタイムログ受信      │ │
                    │  • データベース保存          │ │
                    │  • クライアント配信          │ │
                    └──────────────────────────────┘
                                │
                                ▼
                    ┌──────────────────────────────┐
                    │         MongoDB              │
                    │     (永続化ストレージ)        │ │
                    └──────────────────────────────┘
                                │
                                ▼
                    ┌──────────────────────────────┐
                    │      管理パネル              │ │
                    │   (リアルタイム表示)          │ │
                    └──────────────────────────────┘
```

## コンポーネント説明

### 1. keruta-agent
- **役割**: スクリプト実行とログキャプチャ
- **機能**:
  - サブプロセスの標準出力・標準エラー出力をリアルタイムキャプチャ
  - WebSocket経由でkeruta本体にログを送信
  - ローカルログ出力

### 2. keruta API (Spring Boot)
- **役割**: ログ受信・保存・配信の中枢
- **機能**:
  - WebSocketエンドポイントでのログ受信
  - データベースへの永続化
  - クライアントへのリアルタイム配信

### 3. MongoDB
- **役割**: ログデータの永続化ストレージ
- **機能**:
  - 構造化ログの保存
  - 履歴ログの検索・取得

### 4. 管理パネル
- **役割**: ログのリアルタイム表示
- **機能**:
  - WebSocket接続でのリアルタイムログ受信
  - ログレベルの視覚的表示
  - 履歴ログの表示

## データフロー

### 1. ログ生成
```
User Script → keruta-agent → Log Streaming Engine
```

### 2. ログ配信
```
Log Streaming Engine → WebSocket → keruta API
```

### 3. ログ保存
```
keruta API → MongoDB (永続化)
```

### 4. ログ表示
```
keruta API → WebSocket → 管理パネル
```

## 技術スタック

| コンポーネント | 技術 | 説明 |
|---------------|------|------|
| keruta-agent | Go | スクリプト実行・ログキャプチャ |
| keruta API | Spring Boot | WebSocket・REST API |
| データベース | MongoDB | ログ永続化 |
| 管理パネル | JavaScript/HTML | リアルタイム表示 |
| 通信 | WebSocket | リアルタイム双方向通信 |

## 関連ドキュメント
- [API仕様](./api-specification.md)
- [実装仕様](./implementation-specification.md)
- [使用方法](./usage-guide.md)
- [設定・パフォーマンス](./configuration-performance.md) 