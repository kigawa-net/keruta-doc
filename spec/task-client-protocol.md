# keruta task client protocol (KTCP) 仕様

## 概要

keruta task client protocol (KTCP) は、タスクサーバーとタスク実行プロバイダー（provider）間の通信を制御するためのプロトコルです。タスクの実行管理、状態同期、ログストリーミングを実現します。

## アーキテクチャ

```
┌─────────────────┐          KTCP          ┌─────────────────┐
│   Task Server   │◄─────────────────────►│    Provider     │
│  (keruta-api)   │    WebSocket only     │ (keruta-agent)  │
└─────────────────┘                       └─────────────────┘
```

## 基底プロトコル

KTCP は WebSocket を唯一の通信プロトコルとして使用します。

- **到達保証**: TCP/IP による保証
- **認証**: HTTPヘッダによるOIDCトークン認証
- **メッセージ形式**: JSON-RPC 2.0 ベース
- **接続**: 双方向全二重通信

### メッセージフォーマット

すべての KTCP メッセージは以下の JSON 構造に従います：

```json
{
  "type": "<message_type>",
  "requestId": "<request_id>",  // 応答型メッセージの場合のみ
  "taskId": "<task_id>",        // タスク関連メッセージの場合のみ
  "data": {                     // メッセージ固有のデータ
    // ... メッセージタイプに応じたフィールド
  },
  "timestamp": "<iso8601_timestamp>",
  "version": "1.0"              // オプション: プロトコルバージョン
}
```

#### フィールド説明

| フィールド | 型 | 必須 | 説明 |
|-----------|----|------|------|
| `type` | string | ✓ | メッセージタイプを識別する文字列 |
| `requestId` | string | 応答型のみ | リクエスト-レスポンスのペアを関連付けるUUID |
| `taskId` | string | タスク関連のみ | 対象タスクのUUID |
| `data` | object | ✓ | メッセージ固有のペイロードデータ |
| `timestamp` | string | ✓ | ISO 8601形式のタイムスタンプ |
| `version` | string | オプション | メッセージフォーマットのバージョン |

#### メッセージタイプ分類

- **制御メッセージ**: 接続管理、ハートビート
- **タスク操作メッセージ**: CRUD操作（作成/読み取り/更新/削除）
- **実行管理メッセージ**: タスク実行、状態更新、ログストリーミング
- **エラーメッセージ**: エラー通知とハンドリング

#### WebSocketフレーム仕様

- **テキストフレーム**: JSONメッセージの送信に使用
- **バイナリフレーム**: 大きなログデータやファイル転送に使用（将来拡張）
- **Ping/Pong**: 接続維持のためのハートビート
- **Closeフレーム**: 正常/異常終了時の接続切断

## 通信プロトコル詳細

通信プロトコルの詳細な仕様については、[task-client-protocol-details.md](task-client-protocol-details.md) を参照してください。

## タスク実行ライフサイクル

### 1. 接続確立フェーズ
1. **WebSocket 接続**: プロバイダーがHTTPヘッダによるOIDCトークン認証でサーバーに接続
2. **登録**: プロバイダー能力の通知
3. **ハートビート開始**: 定期的な生存確認

### 2. タスク実行フェーズ
1. **タスク受信**: サーバーから実行要求を受信
2. **環境準備**: 作業ディレクトリ、依存関係の準備
3. **実行開始**: スクリプト実行の開始
4. **状態同期**: リアルタイムでの状態更新
5. **ログストリーミング**: 実行ログの送信

### 3. 完了フェーズ
1. **実行完了**: スクリプト終了
2. **結果通知**: 完了/失敗状態の送信
3. **リソース解放**: クリーンアップ
4. **次のタスク待機**: アイドル状態へ

## エラーハンドリング

### エラーメッセージ形式
```json
{
  "type": "error",
  "code": "CONNECTION_LOST",
  "message": "WebSocket 接続が切断されました",
  "timestamp": "2024-01-01T10:00:00Z",
  "retryable": true
}
```

### エラーコード
- **CONNECTION_LOST**: 接続切断
- **AUTH_FAILED**: 認証失敗
- **INVALID_MESSAGE**: 不正メッセージ
- **TASK_NOT_FOUND**: タスク不存在
- **TASK_ALREADY_EXISTS**: タスク重複
- **TASK_IN_PROGRESS**: 実行中タスクの操作不可
- **PERMISSION_DENIED**: 権限不足
- **VALIDATION_FAILED**: 入力検証失敗
- **EXECUTION_FAILED**: 実行失敗
- **RESOURCE_EXHAUSTED**: リソース不足
- **OPERATION_NOT_SUPPORTED**: サポート外操作

### 汎用エラーメッセージ

各エラーコードに対する標準的なエラーメッセージを以下に示します。これらのメッセージはクライアントがエラーをユーザーに表示する際に使用できます。

| エラーコード | 汎用メッセージ | 説明 |
|-------------|---------------|------|
| CONNECTION_LOST | WebSocket接続が切断されました。再接続を試みてください。 | ネットワーク接続の問題による接続切断 |
| AUTH_FAILED | 認証に失敗しました。正しい認証情報を使用してください。 | JWTトークンの無効化または権限不足 |
| INVALID_MESSAGE | メッセージ形式が不正です。プロトコル仕様を確認してください。 | JSON形式の誤りまたは必須フィールドの欠如 |
| TASK_NOT_FOUND | 指定されたタスクが見つかりません。 | タスクIDの誤りまたは既に削除されたタスク |
| TASK_ALREADY_EXISTS | 同じタスクが既に存在します。 | タスクの重複作成防止 |
| TASK_IN_PROGRESS | タスクが実行中です。現在操作できません。 | 実行中のタスクに対する不正な操作 |
| PERMISSION_DENIED | この操作を行う権限がありません。 | ユーザーの権限不足 |
| VALIDATION_FAILED | 入力データの検証に失敗しました。 | リクエストデータの形式エラー |
| EXECUTION_FAILED | タスクの実行に失敗しました。詳細なログを確認してください。 | タスク実行時の内部エラー |
| RESOURCE_EXHAUSTED | 利用可能なリソースが不足しています。後で再試行してください。 | CPU、メモリ、ストレージなどのリソース不足 |
| OPERATION_NOT_SUPPORTED | この操作はサポートされていません。 | プロトコルバージョンまたは機能の互換性問題 |

### リトライポリシー
- **指数バックオフ**: 1s, 2s, 4s, 8s...
- **最大リトライ数**: 5回
- **対象エラー**: 接続エラー、一時的な失敗

## セキュリティ

### 通信の暗号化
- **必須**: WSS (WebSocket Secure) の使用
- **証明書**: 有効な SSL/TLS 証明書

### 認証と認可
- **OIDC トークン**: Keycloak 発行のトークン
- **スコープ検証**: プロバイダー権限の確認
- **CRUD 権限**: タスクの作成/読み取り/更新/削除に対する個別権限制御
- **トークン更新**: 有効期限内の自動更新

### メッセージ検証
- **スキーマ検証**: JSON スキーマによる構造検証
- **入力サニタイズ**: スクリプト、コマンドの安全チェック
- **サイズ制限**: メッセージサイズの上限設定

## パフォーマンス最適化

### 接続管理
- **接続プーリング**: 複数プロバイダーの同時接続
- **再接続ロジック**: 自動再接続とエクスポネンシャルバックオフ
- **接続タイムアウト**: アイドル接続の自動切断

### メッセージ最適化
- **バイナリメッセージ**: 大きなログデータの効率的転送
- **圧縮**: メッセージペイロードの圧縮
- **バッチ処理**: 複数ログの一括送信

### リソース管理
- **同時実行制限**: プロバイダーごとの最大タスク数
- **キューイング**: 過負荷時のタスクキューイング
- **負荷分散**: 複数プロバイダー間でのタスク分散

## バージョン互換性

### プロトコルバージョン
- **KTCP/1.0**: 基本 WebSocket 通信
- **KTCP/1.1**: バイナリメッセージ、圧縮サポート
- **KTCP/1.2**: 高度なエラーハンドリング、バッチ処理

### バージョン識別
```json
{
  "type": "handshake",
  "protocolVersion": "KTCP/1.2",
  "clientVersion": "keruta-agent/1.2.0"
}
```

## 監視とメトリクス

### 接続メトリクス
- アクティブ接続数
- 接続継続時間
- 再接続回数

### メッセージメトリクス
- メッセージスループット
- エラー率
- レスポンスタイム

### タスクメトリクス
- 実行中のタスク数
- 完了/失敗タスク数
- 平均実行時間

この KTCP 仕様により、タスクサーバーとプロバイダー間の信頼性が高く効率的な通信を実現します。

